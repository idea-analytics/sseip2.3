---
title: "ETL Pull IDEA Data"
author: "Steven Macapagal"
date: "2023-09-28"
output: html_document
---

## Setup

- Last modified: 2024-10-10
- Last deployed (development): 2023-11-11
- Last deployed (production):
- Inputs:
- Outputs: sf_students_idea_mvp, sf_schools_idea_mvp, sf_isochrones_idea_mvp


This ETL will pull student data, geocode it, and transform into an sf data frame. Geocoded IDEA schools and sites will also be transformed into an sf data frame, and their 5, 10 and 15 minute isochrones will be computed.

```{r setup_doc}
knitr::opts_chunk$set(echo = TRUE)

# allows pins to work from RSConnect 
httr::set_config(httr::config(ssl_verifypeer = FALSE, ssl_verifyhost = FALSE))
```

### Load libraries

```{r setup_libraries}
library(tidyverse)
library(ideadata)
library(sf)
library(mapboxapi)
library(tidygeocoder)
library(pins)
library(sfarrow)
```

### Define tables, parameters, functions

```{r define_tables}
df_counties_tx <- tibble::tribble(
  ~ state, ~ region, ~ county,
  
  "TX", "Austin", "Travis County",
  "TX", "Austin", "Hays County",
  "TX", "Austin", "Bastrop County",
  "TX", "Austin", "Williamson County",
  
  # "TX", "Coastal Bend", "Nueces County",

  "TX", "El Paso", "El Paso County",
  
  "TX", "Greater Houston Area", "Harris County",
  "TX", "Greater Houston Area", "Montgomery County",

  "TX", "Permian Basin", "Midland County",
  "TX", "Permian Basin", "Ector County",
  
  "TX", "Rio Grande Valley", "Cameron County",
  "TX", "Rio Grande Valley", "Hidalgo County",
  "TX", "Rio Grande Valley", "Starr County",
  
  "TX", "San Antonio", "Bexar County",
  "TX", "San Antonio", "Comal County",
  
  "TX", "Tarrant County", "Tarrant County",
  "TX", "Tarrant County", "Dallas County"
)

df_counties_ips <- tibble::tribble(
  ~ state, ~ region, ~ county,
  
  "OH", "Cincinnati", "Hamilton County",
  
  "FL", "Jacksonville", "Duval County",
  "FL", "Tampa", "Hillsborough County",
  "FL", "Tampa", "Polk County",
  # "FL", "Orlando", "Orange County",
  
  "LA", "Southern Louisiana", "East Baton Rouge Parish",
  "LA", "Southern Louisiana", "Orleans Parish"
)

df_counties_all <- dplyr::bind_rows(
  df_counties_tx,
  df_counties_ips
)

df_geolocated_schools <- get_table(.table_name = "SchoolsGeocoded",
                                   .server_name = "RGVPDRA-DASQL",
                                   .database_name = "Dashboard",
                                   .schema = "dbo") %>%
  collect()

# df_geolocated_schools <- readr::read_csv(here::here("etl","GIS sites data summary.csv"))%>%
#   janitor::clean_names()%>%
#   dplyr::select(region:longitude)%>%
#   dplyr::distinct() %>%
#   dplyr::select(region,
#          school_short_name,
#          school_street = addresses, 
#          school_city = city, 
#          school_state = state, 
#          school_zip_code = zip,
#          county,
#          lat = latitude,
#          long = longitude)

# mvp_regions <- c("Austin", "Permian Basin", "Tarrant County", "Cincinnati", "Jacksonville", "Tampa")
# 
# mvp_counties <- df_counties_all %>%
#   dplyr::filter(region %in% mvp_regions) %>%
#   dplyr::pull(county)
```


```{r define_parameters}
# IDEA-related parameters ----
CURRENT_ACADEMIC_YEAR <- "2024-2025"
CURRENT_SCHOOL_TERM_ID <- 3400

# other parameters ----

```


```{r define_functions}
## get_geocoded_schools(region)
## get IDEA schools and geocode

get_geocoded_schools <- function(region = NULL) {

  geocoded_schools <- ideadata::get_schools() %>%
    dplyr::inner_join(ideadata::get_regions() %>%
                 dplyr::filter(RegionDescription == region) %>%
                 dplyr::select(RegionID),
               by = c("RegionID" = "RegionID")) %>%
    dplyr::select(SchoolShortName, SchoolStreet, SchoolCity, SchoolState, SchoolZipCode) %>%
    dplyr::collect() %>%
    dplyr::distinct(SchoolShortName, .keep_all = TRUE ) %>%
    janitor::clean_names() %>%
    tidygeocoder::geocode(street = school_street,
                          city = school_city,
                          state = school_state,
                          postalcode = school_zip_code,
                          method = "geocodio")

  return(geocoded_schools)

}


## add_geocoded_school()
## creates geocoded sf object for a given site
## should be used with get_geocoded_schools() %>% add_geocoded_school()

add_geocoded_school <- function(.data,
                          school_short_name = NULL,
                          school_street = NULL,
                          school_city = NULL,
                          school_state = NULL,
                          school_zip_code = NULL,
                          lat = NULL,
                          long = NULL) {
  
  if ((hasArg(lat) & !hasArg(long)) | (!hasArg(lat) & hasArg(long))) {
    
    stop("Cannot create an sf object without both latitude and longitude. Provide both or leave both out.")
    
  }
  
  if (hasArg(lat) & hasArg(long)) {
    
    return(tibble::add_row(.data,
            school_short_name = school_short_name,
            school_street = school_street,
            school_city = school_city,
            school_state = school_state,
            school_zip_code = as.numeric(school_zip_code),
            lat = lat,
            long = long))
    
  }
  
  if (!hasArg(lat) & !hasArg(long)) {
    
    new_geocoded_school <- data.frame(school_short_name = school_short_name,
          school_street = school_street,
          school_city = school_city,
          school_state = school_state,
          school_zip_code = as.numeric(school_zip_code)) %>%
            dplyr::mutate(school_zip_code = as.character(school_zip_code)) %>%
    tidygeocoder::geocode(street = school_street,
            city = school_city,
            state = school_state,
            postalcode = school_zip_code,
            method = "geocodio") %>%
      dplyr::mutate(school_zip_code = as.numeric(school_zip_code))
    
    dplyr::add_row(.data, new_geocoded_school)
    
  }
  
}

## st_as_sf_schools(.data, crs = "WGS84")
## takes a geocoded data frame and returns a simple features frame

st_as_sf_schools <- function(.data, crs = "WGS84") {
  
  sf_schools <- sf::st_as_sf(.data, coords = c("Longitude", "Latitude")) %>%
    sf::st_set_crs("WGS84")
  
  return(sf_schools)
  
}

## get_sf_isochrone(.data, profile, time)
## creates sf isochrone for an sf object

get_sf_isochrone <- function(.data, profile = NULL,
                             time = NULL,
                             school = NULL, ...) {
  
  if (!is.null(school)) {
    
    sf_isochrone <- mapboxapi::mb_isochrone(.data, 
                                            profile = profile, 
                                            time = time, ...) %>%
      dplyr::bind_cols(tibble::as_tibble(.data) %>% 
                  dplyr::select(-geometry)) %>%
      dplyr::filter(school_short_name == school) %>%
      sf::st_set_crs("WGS84")
    
  } else {
    
    sf_isochrone <- mapboxapi::mb_isochrone(.data, 
                                            profile = profile, 
                                            time = time, ...) %>%
      dplyr::bind_cols(tibble::as_tibble(.data) %>% 
                  dplyr::select(-geometry)) %>%
      sf::st_set_crs("WGS84")

  }
  
  return(sf_isochrone)
  
}

## get_geocoded_students(region)
## get IDEA students and geocode

get_geocoded_students <- function(region = NULL) {
  
  message(paste("Attempting student geocodes for the region:", region))
  
  df_schools <- ideadata::get_regions() %>%
    dplyr::filter(RegionDescription == region) %>%
    dplyr::select(RegionID,
           RegionDescription) %>%
    dplyr::inner_join(ideadata::get_schools() %>%
                 dplyr::select(SchoolNumber,
                        SchoolName,
                        SchoolShortName,
                        RegionID),
               by = c("RegionID" = "RegionID"))
  
  df_students <- ideadata::get_students() %>%
    dplyr::filter(SchoolTermID == CURRENT_SCHOOL_TERM_ID) %>%
    dplyr::select(StudentNumber,
           Grade = GradeLevelID,
           ECDFlag,
           SchoolNumber, 
           PhysicalStreet, 
           PhysicalCity, 
           PhysicalState, 
           PhysicalZIP) %>%
    dplyr::inner_join(df_schools,
              by = c("SchoolNumber" = "SchoolNumber")) %>%
    dplyr::filter(RegionDescription == region) %>%
    dplyr::collect() %>%
    janitor::clean_names() # %>%
  
  # geocodio has a max of 10,000 students per query
  # this will compute how many queries need to be sent
  
  n_students <- nrow(df_students)
  n_groups <- ceiling(n_students / 10000)
  
  # n_groups == 1 is the original code
  
  message(paste("Number of students identified:", n_students))
  message(paste("Number of iterations identified:", n_groups))
  
  if (n_groups == 1) {
    
    df_students_geocoded <- df_students %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
  } else if (n_groups == 2) {
    
    df_students_geocoded_1 <- df_students[1:10000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2
    )
    
  } else if (n_groups == 3) {
    
    df_students_geocoded_1 <- df_students[1:10000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3
    )
    
  } else if (n_groups == 4) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4
    )
    
  } else if (n_groups == 5) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:40000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 4 (40000 cumulative observations) completed")
    
    df_students_geocoded_5 <- df_students[40001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4,
      df_students_geocoded_5
    )
    
  } else if (n_groups == 6) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:40000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 4 (40000 cumulative observations) completed")
    
    df_students_geocoded_5 <- df_students[40001:50000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 5 (50000 cumulative observations) completed")
    
    df_students_geocoded_6 <- df_students[50001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4,
      df_students_geocoded_5,
      df_students_geocoded_6
    )
    
  } else if (n_groups == 7) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:40000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 4 (40000 cumulative observations) completed")
    
    df_students_geocoded_5 <- df_students[40001:50000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 5 (50000 cumulative observations) completed")
    
    df_students_geocoded_6 <- df_students[50001:60000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 6 (60000 cumulative observations) completed")
    
    df_students_geocoded_7 <- df_students[60001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4,
      df_students_geocoded_5,
      df_students_geocoded_6,
      df_students_geocoded_7
    )
    
  } else if (n_groups == 8) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:40000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 4 (40000 cumulative observations) completed")
    
    df_students_geocoded_5 <- df_students[40001:50000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 5 (50000 cumulative observations) completed")
    
    df_students_geocoded_6 <- df_students[50001:60000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 6 (60000 cumulative observations) completed")
    
    df_students_geocoded_7 <- df_students[60001:70000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 7 (70000 cumulative observations) completed")
    
    df_students_geocoded_8 <- df_students[70001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4,
      df_students_geocoded_5,
      df_students_geocoded_6,
      df_students_geocoded_7,
      df_students_geocoded_8
    )
    
  } else if (n_groups == 9) {
    
    df_students_geocoded_1 <- df_students[1:10000,] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 1 (10000 cumulative observations) completed")
    
    df_students_geocoded_2 <- df_students[10001:20000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 2 (20000 cumulative observations) completed")
    
    df_students_geocoded_3 <- df_students[20001:30000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 3 (30000 cumulative observations) completed")
    
    df_students_geocoded_4 <- df_students[30001:40000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 4 (40000 cumulative observations) completed")
    
    df_students_geocoded_5 <- df_students[40001:50000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 5 (50000 cumulative observations) completed")
    
    df_students_geocoded_6 <- df_students[50001:60000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 6 (60000 cumulative observations) completed")
    
    df_students_geocoded_7 <- df_students[60001:70000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 7 (70000 cumulative observations) completed")
    
    df_students_geocoded_8 <- df_students[70001:80000, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message("Group 8 (80000 cumulative observations) completed")
    
    df_students_geocoded_9 <- df_students[80001:n_students, ] %>%
      tidygeocoder::geocode(street = physical_street,
                            city = physical_city,
                            state = physical_state,
                            postalcode = physical_zip,
                            method = "geocodio")
    
    message(paste0("All groups (", n_students, " cumulative observations) completed"))
    
    df_students_geocoded <- dplyr::bind_rows(
      df_students_geocoded_1,
      df_students_geocoded_2,
      df_students_geocoded_3,
      df_students_geocoded_4,
      df_students_geocoded_5,
      df_students_geocoded_6,
      df_students_geocoded_7,
      df_students_geocoded_8,
      df_students_geocoded_9
    )
    
  }
  
  message(paste("Completed student geocodes for the region:", region))
  
  return(df_students_geocoded)
  
}

## st_as_sf_students(.data, crs = "WGS84")
## takes a data frame and returns a special features object with defined CRS

st_as_sf_students <- function(.data, crs = "WGS84") {
  
  sf_students <- dplyr::filter(.data, !(is.na(long))) %>%
    sf::st_as_sf(coords = c("long", "lat")) %>%
    sf::st_set_crs(crs)
  
  return(sf_students)
  
}

```


## Pull data

```{r pull_data}
# pulls current IDEA students, geocodes, and turns into sf
sf_students_idea <- df_counties_all %>%
  # dplyr::filter(region %in% mvp_regions) %>%
  dplyr::distinct(region) %>%
  # df:
  # ~ region
  purrr::pmap(get_geocoded_students) %>%
  purrr::list_rbind() %>%
  st_as_sf_students()
```

```{r get_sf_schools_data}
# turns current IDEA schools into sf
sf_schools_idea <- df_geolocated_schools %>%
  # dplyr::filter(region %in% mvp_regions) %>%
  st_as_sf_schools()


sf_isochrones_idea <- sf_schools_idea %>%
  {
    list(
      get_sf_isochrone(., "driving", 1),
      get_sf_isochrone(., "driving", 2),
      get_sf_isochrone(., "driving", 3),
      get_sf_isochrone(., "driving", 4),
      get_sf_isochrone(., "driving", 5),
      get_sf_isochrone(., "driving", 6),
      get_sf_isochrone(., "driving", 7),
      get_sf_isochrone(., "driving", 8),
      get_sf_isochrone(., "driving", 9),
      get_sf_isochrone(., "driving", 10),
      get_sf_isochrone(., "driving", 11),
      get_sf_isochrone(., "driving", 12),
      get_sf_isochrone(., "driving", 13),
      get_sf_isochrone(., "driving", 14),
      get_sf_isochrone(., "driving", 15)
    )
  } %>%
  purrr::list_rbind() %>%
  sf::st_as_sf() %>%
  sf::st_set_crs("WGS84")
```

## Write to Feather

```{r}
working_dir <- here::here("app")

# Save as arrow files
st_write_feather(sf_schools_idea, glue::glue("{working_dir}/sf_schools_idea_2024.feather"))
st_write_feather(sf_isochrones_idea, glue::glue("{working_dir}/sf_isochrones_idea_2024.feather"))
st_write_feather(sf_students_idea, glue::glue("{working_dir}/sf_students_idea_2024.feather"))

st_write_feather(sf_dot_density, glue::glue("{working_dir}/sf_dot_density.feather"))
```


## Pin data

```{r pin_data}
# attach to pins board ----
# board_posit <- pins::board_connect()
# 
# board_posit %>%
#   pins::pin_write(
#     sf_students_idea_mvp,
#     name = "dashboard_geolocated_idea_students",
#     description = "Geolocated IDEA students",
#     type = "qs"
#   )
# 
# board_posit %>%
#   pins::pin_write(
#     sf_schools_idea_mvp,
#     name = "dashboard_geolocated_idea_schools",
#     description = "Geolocated IDEA schools and sites",
#     type = "qs"
#   )
# 
# board_posit %>%
#   pins::pin_write(
#     sf_isochrones_idea_mvp,
#     name = "dashboard_isochrones_for_idea_schools",
#     description = "Isochrones IDEA schools and sites",
#     type = "qs"
#   )
```


